# 数字图像处理实验指导书

## 实验一、自适应Gamma校正

### 一、实验目的

1. 掌握图像亮度调整的基本原理，理解Gamma校正的非线性特性。
2. 学习在不同颜色空间（如YCbCr）中分离亮度通道并进行自适应参数估计的方法。
3. 掌握数值优化算法（如二分法）在图像处理中的应用。
4. 分析自适应Gamma校正对图像亮度控制的精确度及误差来源。

---

### 二、实验原理

1. **Gamma校正原理**  
   通过非线性变换调整图像亮度，公式为：  
   $$ Y_{\text{out}} = Y_{\text{in}}^{\gamma} $$  
   其中，$\gamma > 1$ 时图像变暗，$\gamma < 1$ 时图像变亮。

2. **自适应参数估计**  
   根据输入图像的平均亮度 $\mu_{\text{in}}$ 与目标亮度 $\mu_{\text{target}}$，通过数值优化方法求解满足以下方程的Gamma值：  
   $$ \frac{1}{N} \sum_{i=1}^{N} Y_i^{\gamma} = \mu_{\text{target}} $$

3. **颜色空间转换**  
   在YCbCr颜色空间中，亮度（Y）与色度（Cb、Cr）分离，避免调整亮度时产生色偏。

4. **亮度均值计算**  
   对归一化后的亮度通道（$Y \in [0,1]$）求均值，作为当前亮度指标。

---

### 三、实验内容

1. 实现图像颜色空间转换（RGB ↔ YCbCr），提取并处理亮度通道。
2. 编写代码计算输入图像的亮度均值，并通过二分法求解自适应Gamma值。
3. 对亮度通道应用Gamma校正，合并色度通道后转换回RGB空间。
4. 评估输出图像亮度均值与目标值的误差，分析不同图像内容对校正精度的影响。

---

### 四、实验步骤

#### 1. 输入与初始化
- 选择图像文件，程序读取并转换为RGB格式（若输入为多通道图像）。
- 设置默认参数：亮度范围 **Lmin=0**、**Lmax=255**，显示标志 **bDisplay**。

#### 2. 颜色空间选择与亮度提取
- 选择颜色空间（RGB/YCbCr/HSV/Gray）。
- 根据颜色空间提取亮度通道：
  1. **RGB**：取RGB三通道的最大值作为亮度。
  2. **YCbCr**：提取Y通道（亮度），并设置标准范围 **Lmin=16**、**Lmax=235**。
  3. **HSV**：提取V通道（明度）。
  4. **Gray**：直接处理灰度图像。

#### 3. Gamma值计算
- **RGB空间**：分别计算R、G、B通道的Gamma值，取最大值或均值。
- **其他颜色空间**：
  1. 归一化亮度：  
     $$ \text{uniformMat} = \frac{\text{img\_gray} - L_{\text{min}}}{L_{\text{max}} - L_{\text{min}}} $$
  2. 计算平均亮度均值 **AvguniMat**。
  3. 使用公式：  
     $$ \gamma = \frac{\log_{10}(0.5)}{\log_{10}(\text{AvguniMat})} $$  
     将平均亮度映射到0.5（目标亮度）。

#### 4. Gamma校正与后处理
- 应用公式：  
  $$ \text{gamaMat} = \text{uniformMat}^{\gamma} $$  
  反归一化后得到校正亮度。
- 合并色度通道并转换回RGB空间（若需要）：
  1. **YCbCr**：调整Cb/Cr通道增益（×1.5），可能引入色偏。
  2. **HSV**：仅调整V通道后转换回RGB。

#### 5. 结果显示与调试
- 显示输入图像与校正后图像（通过 **imtool**）。
- 绘制Gamma曲线（输入亮度与校正后亮度的关系）。

---

### 五、关键代码解析

 Gamma计算逻辑
```matlab
gamma = log10(0.5) / log10(AvguniMat)
该公式假设目标亮度为0.5（归一化值），通过调整Gamma使得校正后的平均亮度接近0.5。但未处理 AvguniMat 接近0或1的极端情况，可能导致计算溢出。

颜色空间处理差异
YCbCr：Y通道范围调整（16~235），但Cb/Cr通道被手动缩放（×1.5），可能导致色度失真。

RGB：对三通道分别计算Gamma，但最终取最大值，可能导致过度增强。

六、思考题
颜色空间选择
若改用HSV或Lab颜色空间调整亮度（V或L通道），实验结果会有何差异？试分析原因。

优化算法对比
将二分法替换为牛顿迭代法或黄金分割法，比较计算效率和精度变化。

误差分析
实验中发现某些图像（如大面积纯黑或纯白）的校正误差较大，可能是什么原因？如何改进？

实际应用限制
若直接将本方法用于监控摄像头自动亮度调节，可能存在哪些问题？提出解决方案。

七、实验报告要求
提交完整代码、测试图像及结果对比图（输入/输出）。

记录不同目标亮度下的误差数据，绘制误差随目标值变化的曲线图。

结合思考题，分析实验方法的优缺点及改进方向。